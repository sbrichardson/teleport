# Teleport for Kubernetes

This example shows how to configure Teleport as an authentication proxy for
Kubernetes. Specifically, it shows how to configure Teleport and
[minikube](https://minikube.sigs.k8s.io/docs/) locally on your machine.

For general-purpose instructions, see our [Kubernetes
guide](https://gravitational.com/teleport/docs/kubernetes_ssh/)

> **Note**: Teleport is not using the official Kubernetes [authenticating
> proxy](https://kubernetes.io/docs/reference/access-authn-authz/authentication/#authenticating-proxy)
mechanism. That mechanism requires making changes to `kube-apiserver` flags,
which is not possible with most hosted Kubernetes providers.

## Setup minikube

Follow the [official minikube
instructions](https://minikube.sigs.k8s.io/docs/start/) for setup. After you
have it set up, run:

```
$ minikube start
$ kubectl cluster-info
```

If the above commands succeed, you're good to go.

## Setup Teleport

Follow the [installation
instructions](https://github.com/gravitational/teleport/#installing-and-running)
to get the Teleport binaries. Make sure they are in your `$PATH`:

```
$ teleport version
$ tctl version
$ tsh version
```

## Start Teleport auth server

Copy the template config from `templates/teleport-auth.yaml` and replace any
fields marked as `REPLACE_ME`. Then, start the server:

```
$ teleport start -c /path/to/teleport-auth.yaml
```

This command will block while the server is running. Start a new terminal to
continue.

## Get a join token for Teleport proxy

Run this to get a 30-minute token for the proxy to authenticate with auth
server:

```
$ tctl -c /path/to/teleport-auth.yaml nodes add --roles=proxy
```

We will refer to this token as `$PROXY_JOIN_TOKEN` below.

## Start Teleport proxy

There are two ways to run the proxy: standalone or as a pod in your cluster.

### Standalone

Copy the minikube-generated `kubeconfig` file, making sure that the context is
set to `minikube`:

```
$ kubectl config use-context minikube
$ cp ~/.kube/config /path/to/kubeconfig
```

> **Note**: we copy the `kubeconfig` because `tsh login` later on will modify
> it for the logged-in user. By copying, we avoid any confusion between
> Kubernetes credentials used by the proxy and those used by the user.

> **Warning**: the kubeconfig generated by minikube authenticates as a member
> of `system:masters` group. For the purposes of a local demo that's
> acceptable. In a real production cluster you should follow the principle of
> least privilege and create a dedicated identity with [only essential
> permissions](https://gravitational.com/teleport/docs/kubernetes_ssh/#impersonation).

Copy the template config from `templates/teleport-proxy-standalone.yaml` and
replace any fields marked as `REPLACE_ME`. Then, start the server:

```
$ teleport start -c /path/to/teleport-proxy.yaml --token ${PROXY_JOIN_TOKEN}
```

This command will block while the server is running. Start a new terminal to
continue.

### Pod in cluster

Copy the template Kubernetes object definitions from
`templates/teleport-proxy-k8s.yaml` and replace any fields marked as
`REPLACE_ME`. Then, create the Kubernetes objects:

```
$ kubectl --context minikube apply -f /path/to/teleport-proxy-k8s.yaml
```

#### Get the proxy IP

Due to the proxy running within a Kubernetes cluster, it won't be reachable via
`localhost`. The `kubectl` command above created a `Service` of type
`LoadBalancer` to get a routable address. With minikube, this `Service` won't
get an IP assigned right away. Open a new terminal and run:

```
# minikube tunnel
```

This command will block while the tunnel is running. While it's running, the
services within a minikube cluster will get routable IPs assigned.

To get the IP of the Teleport proxy, run:

```
$ kubectl --namespace teleport-system get service proxy-service \
    -o 'jsonpath={.status.loadBalancer.ingress[0].ip}'
```

Use this IP to reach the proxy, for example with `tsh login` or browser
pop-ups.

## Create a Teleport user

Run this to create a new Teleport account for login:

```
# You can add this user to arbitrary Kubernetes groups with --k8s-groups flag.
# For this example, we'll use "system:masters" to get unrestricted access to
# Kubernetes API.
#
# You can also write Kubernetes RBAC policies for the User account directly.
$ tctl -c /path/to/teleport-auth.yaml users add $USER --k8s-groups=system:masters
```

Follow instructions from the output to complete user registration.

## Login to Teleport proxy

Use the usual `tsh login` command to login. If you run the proxy as a pod, use
`minikube ip` to get `$PROXY_ADDR`; otherwise, use `localhost`.

```
# Only use --insecure for local testing when your proxy doesn't have a valid
# TLS server certificate.
$ tsh login --proxy=$PROXY_ADDR --insecure
```

## Test our your access

Now you're logged in and `kubectl` is configured to send commands through
Teleport proxy using your Teleport credentials. Try a few commands:

```
$ kubectl get pods --all-namespaces
$ kubectl auth can-i --list
```

## Cleaning up

- stop the Teleport auth server with `Ctrl-C`
- if Teleport proxy was running standalone, stop it with `Ctrl-C`
- stop the minikube cluster with `minikube stop`
